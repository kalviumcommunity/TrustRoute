generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  bookings  Booking[]
}

model BusOperator {
  id             String         @id @default(cuid())
  name           String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  bookings       Booking[]
  refundPolicies RefundPolicy[]
}

model RefundPolicy {
  id         String      @id @default(cuid())
  operatorId String
  rules      Json
  version    Int         @default(1)
  isCurrent  Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  bookings   Booking[]
  operator   BusOperator @relation(fields: [operatorId], references: [id])
}

model Booking {
  id                String             @id @default(cuid())
  userId            String
  operatorId        String
  policyId          String
  amount            Float
  status            BookingStatus      @default(CONFIRMED)
  seatNumber        String?
  passengerName     String?
  travelDate        DateTime?
  route             String?
  departureTime     String?
  cancelledAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  operator          BusOperator        @relation(fields: [operatorId], references: [id])
  policy            RefundPolicy       @relation(fields: [policyId], references: [id])
  user              User               @relation(fields: [userId], references: [id])
  refundTransaction RefundTransaction?
}

model RefundTransaction {
  id               String       @id @default(cuid())
  bookingId        String       @unique
  refundAmount     Float
  deductionTotal   Float
  breakdown        Json
  status           RefundStatus @default(INITIATED)
  timeline         Json
  initiatedAt      DateTime?
  processingAt     DateTime?
  creditedAt       DateTime?
  cancellationSlot String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  booking          Booking      @relation(fields: [bookingId], references: [id])
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum RefundStatus {
  INITIATED
  PROCESSING
  COMPLETED
  FAILED
}
